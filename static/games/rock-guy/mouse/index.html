<!DOCTYPE HTML>
<html>
<head>
	<title></title>
	<meta name="viewport" content="width=device-width, maximum-scale=1.0" />
	<meta name="apple-mobile-web-app-capable" content="yes" /> 
	<style> body { margin: 0; padding: 0; } </style>
</head>
<body>
<span id="test1">test1</span>
<span id="test2">test2</span>
<span id="test3">test3</span>
<span id="test4">test4</span>
<span id="test5">test5</span>
<br/>
<span id="test6">test6</span>
<span id="test7">test7</span>
<br/>

<canvas width="1024" height="680" id="bgcanvas" style="position:absolute; z-index: 0;"></canvas>
<canvas width="1024" height="680" id="canvas" style="position:absolute; z-index: 1"></canvas>
<script type="text/javascript">
// Source: http://paulirish.com/2011/requestanimationframe-for-smart-animating/
// Cross platform requestAnimationFrame and setTimeout fallback
window.requestAnimFrame = (function(callback){
	return window.requestAnimationFrame ||
	window.webkitRequestAnimationFrame ||
	window.mozRequestAnimationFrame ||
	window.oRequestAnimationFrame ||
	window.msRequestAnimationFrame ||
	function(callback){
		window.setTimeout(callback, 1000 / 60);
	};
})();

// Source: http://www.html5rocks.com/en/tutorials/games/assetmanager/
// Asset Manager - Preloads assets
function AssetManager(){
	this.successCount = 0;
	this.errorCount = 0;
	this.cache = {};
	this.downloadQueue = [];
}

AssetManager.prototype.queueDownload = function(path){
	this.downloadQueue.push(path)
}

AssetManager.prototype.downloadAll = function(downloadCallBack){
	if (this.downloadQueue.length === 0){
		downloadCallBack();
	}
	
	for (var i=0; i < this.downloadQueue.length; i++){
		var path = this.downloadQueue[i];
		var img = new Image();
		var that = this;
		img.addEventListener("load", function(){
			console.log(this.src + ' is loaded');
			that.successCount += 1;
			if (that.isDone()){
				downloadCallBack();
			}
		}, false);
		img.addEventListener("error", function(){
			that.errorCount += 1;
			if (that.isDone()){
				downloadCallBack();
			}
		}, false);
		img.src = path;
		this.cache[path] = img;
	}
}

AssetManager.prototype.getAsset = function(path){
	return this.cache[path];
}

AssetManager.prototype.isDone = function(){
	return (this.downloadQueue.length == this.successCount + this.errorCount);
}

var inputEvent = ""; // IGNORE THIS, FOR TESTING

/////////// Image Loading Stuff
var ASSET_MANAGER = new AssetManager();
ASSET_MANAGER.queueDownload('img/fireSprite.png');
ASSET_MANAGER.queueDownload('img/iceSprite.png');
ASSET_MANAGER.queueDownload('img/monster.png');
ASSET_MANAGER.queueDownload('img/monsterarmleft.png');
ASSET_MANAGER.queueDownload('img/monsterarmright.png');
ASSET_MANAGER.queueDownload('img/background_trees0.png');
ASSET_MANAGER.queueDownload('img/background_trees1.png');
ASSET_MANAGER.queueDownload('img/background.png');
ASSET_MANAGER.queueDownload('img/firebomb.png');
ASSET_MANAGER.queueDownload('img/select1.png');
ASSET_MANAGER.queueDownload('img/select2.png');

////////////////////////////////////////////////
/////////////// BACKGROUND /////////////////////
// The background is drawn on a separate canvas to improve foreground performance
////////////////////////////////////////////////
function parallaxScrolling(x,y){
	var trees0 = ASSET_MANAGER.getAsset('img/background_trees0.png');
	var trees1 = ASSET_MANAGER.getAsset('img/background_trees1.png');
	var background = ASSET_MANAGER.getAsset('img/background.png');
	bgContext.fillStyle = "3FA1AA";
	bgContext.fillRect(0, 0, 1024, 680);
	bgContext.drawImage(trees0, -200 + x * 0.1, 0);
	bgContext.drawImage(trees1, -200 + x * 0.2, 0);
	bgContext.drawImage(background, 0, 0);
}


///////////////////////////////////////////////////////
//////////////////// MOVEMENT /////////////////////////
///////////////////////////////////////////////////////
function normalize(x1, y1, x2, y2){
	// Get Length, Get Vector, Return Normalized
	// Required for move()
	var dx = x2 - x1;
	var dy = y2 - y1;
	var length = Math.sqrt(dx*dx + dy*dy);
	var vector = { x: x2 - x1, y: y2 - y1 };
	return { x: vector.x / length, y: vector.y / length }
}

function move(obj, x1, y1, x2, y2){
	var modifier = getDelta();
	var normalized = normalize(x1, y1, x2, y2);
	obj.x += normalized.x * obj.speed * modifier;
	obj.y += normalized.y * obj.speed * modifier;
}

///////////////////////////////////////////////////////
//////////////////// MATH /////////////////////////////
///////////////////////////////////////////////////////
function movePlayerToMonster(obj1, obj, d){
	var dx = obj.x - obj1.x;
	var dy = obj.y + obj1.h - obj1.y;
	var m = Math.sqrt(dx*dx + dy*dy);
	var xmove = (dx / m) * obj1.speed * d;
	var ymove = (dy / m) * obj1.speed * d;
	obj1.x += xmove;
	obj1.y += ymove;
}

function getDistance(x1,y1,x2,y2){	
	var dx = x2 - x1;
	var dy = y2 - y1;
	return Math.ceil(Math.sqrt(dx*dx + dy*dy));
}

///////////////////////////////////////////////////////
//////////////// Important Stuff //////////////////////
///////////////////////////////////////////////////////

var canvas = document.getElementById("canvas");
var context = canvas.getContext("2d");

var bgCanvas = document.getElementById("bgcanvas");
var bgContext = bgCanvas.getContext("2d");

// Used for tracking current mouse/touch position while pressed
// Is usually an array, [0] is mouse & first touch, [1+] is for multitouch
var latestCoords = new Array();
var firstCoords = new Array();
latestCoords[0] = { x: 0, y:0 };
firstCoords[0] = { x: 0, y:0 };

var player = function(){
	return {
		x: 200,
		y: 400,
		w: 128,
		h: 128,
		dx: 0,
		dy: 0,
		frame: 5,
		speed: 500,
		target: null,
		selected: false,
		moving: false,
		action: "stop",
		player: 0,
		selectionTolerance: 96,
		lineColor: "white"
	};
};

var select = function(){
	return {
		x: 0, // Start X
		y: 0, // Start Y
		w: 150,
		h: 64,
		visible: true,
	};
};

// Create the players
var player1 = new player();
var player2 = new player();
var select1 = new select();
var select2 = new select();
player1.player = 1;
player2.player = 2;
player1.lineColor = "#F7931E";
player2.lineColor = "#7BB7BD";

var monster = {
	x: 0,
	y: 0,
	w: 256,
	h: 256,
	color: "red"
};

var bomb = {
	x: 0,
	y: 0,
	w: 128,
	h: 256,
	speed: 1000,
	active: false,
	moving: false
};

var lineActive = false;
var touch = {};
var gesture = false;
///////////////////////////////////////////////////////
//////////////////// RENDER //////////////////////////
///////////////////////////////////////////////////////
function drawPlayer1(obj){
	var frame = player1Frame;
	var size = 128;
	var fireSprite = ASSET_MANAGER.getAsset('img/fireSprite.png');
	context.drawImage(fireSprite, frame * size, 0, size, size, obj.x, obj.y, size, size);
}
function drawPlayer2(obj){
	var frame = player2Frame;
	var size = 128;
	var iceSprite = ASSET_MANAGER.getAsset('img/iceSprite.png');
	context.drawImage(iceSprite, frame * size, 0, size, size, obj.x, obj.y, size, size);
}

/// Don't know how to animate so i made them change every second
var monsterFrame = 0;
var player1Frame = 2;
var player2Frame = 5;

window.setInterval("newFrame()", 1000);
window.setInterval("newPlayer1Frame()", 700);
window.setInterval("newPlayer2Frame()", 850);
function newFrame(){
	if (monsterFrame < 4) monsterFrame++
		else monsterFrame = 0;
}
function newPlayer1Frame(){
	if (player1Frame < 16) player1Frame++
		else player1Frame = 0;
}
function newPlayer2Frame(){
	if (player2Frame < 16) player2Frame++
		else player2Frame = 0;
}


function drawMonster(obj){
	var frame = monsterFrame;
	var size = 256;
	var monster = ASSET_MANAGER.getAsset('img/monster.png');
	context.drawImage(monster, frame * size, 0, size, size, obj.x, obj.y, size, size);
}

function drawSelect(obj){
	if (obj.player == 1){
		var imgSelect1 = ASSET_MANAGER.getAsset('img/select1.png');
		context.drawImage(imgSelect1, 0,0, 150, 64, player1.x, player1.y + player1.h - 45, 150, 64);
	} else if (obj.player == 2){
		var imgSelect2 = ASSET_MANAGER.getAsset('img/select2.png');
		context.drawImage(imgSelect2, 0,0, 150, 64, player2.x, player2.y + player2.h - 45, 150, 64);
	}
}
function drawLine(){
	var lineColor;
	var x,y;
	x = firstCoords[0].x;
	y = firstCoords[0].y;
	if (player1.selected) {
		lineColor = player1.lineColor;
		x = player1.x + 75;
		y = player1.y + 113;
	} else if (player2.selected) {
		lineColor = player2.lineColor;
		x = player2.x + 75;
		y = player2.y + 113;
	} else {
		lineColor = "white";
	}
	context.beginPath();
	context.moveTo(x,y);
	context.lineTo(latestCoords[0].x, latestCoords[0].y);
	context.lineWidth = 10;
	context.lineCap = "round";
	context.strokeStyle = lineColor;
	context.stroke();
	context.closePath();
}

function drawBomb(){
	var imgbomb = ASSET_MANAGER.getAsset('img/firebomb.png');
	context.drawImage(imgbomb, 0, 0, 128, 256, bomb.x, bomb.y, bomb.w, bomb.h);
}

// Don't know how to animation yet, so for now it'll just change sprite frame
function currentFrame(){
	switch (player1.action){
		case "attack": player1.frame = 6; break;
		case "move": player1.frame = 2; break;
		case "bomb": player1.frame = 0; break;
		default: player1.frame = 5;
	}
	switch (player2.action){
		case "attack": player2.frame = 6; break;
		case "move": player2.frame = 2; break;
		case "bomb": player2.frame = 0; break;
		default: player2.frame = 5;
	}
}

function render(){
	parallaxScrolling(player1.x, player1.y);

	if (select1.visible && player1.selected) drawSelect(player1);
	if (select2.visible && player2.selected) drawSelect(player2);

	drawMonster(monster);

	if (lineActive) drawLine();

	drawPlayer2(player2);
	drawPlayer1(player1);
	if (bomb.active){ drawBomb(); }
}

///////////////////////////////////////////////////////
////////////////////// UPDATE /////////////////////////
///////////////////////////////////////////////////////
function update(){
	currentFrame(); // Updates sprite frames

	// Move player to monster
	if (player1.target == "monster" &&
		player1.action == "attack" &&
		player1.x + player1.w < monster.x - 15){
		movePlayerToMonster(player1, monster, getDelta());
	}
	
	switch( player1.action ){
		case "move":
			if (getDistance(player1.x, player1.y, player1.dx, player1.dy) <= 5)
				player1.action = "stop";
			else 
				move(player1, player1.x, player1.y, player1.dx, player1.dy);
			break;
		case "attack":
			break;
		case "bomb":
			dropBomb();
			break;
		case "stop":
			break;
	}

	switch( player2.action ){
		case "move":
			if (getDistance(player2.x, player2.y, player2.dx, player2.dy) <= 5)
				player2.action = "stop";
			else 
				move(player2, player2.x, player2.y, player2.dx, player2.dy);
			break;
		case "attack":
			break;
		case "bomb":
			break;
		case "stop":
			break;
	}
	
	if ( bomb.active ){
		if ( bomb.y + bomb.h <= monster.y + monster.h ){
			move(bomb, bomb.x, bomb.y, bomb.x, monster.y);
		} else {
			bomb.active = false;
			player1.action = "stop";
		}
	}
}

function dropBomb(){
	if(!bomb.active){
		bomb.x = monster.x + monster.w / 2 - bomb.w / 2;
		bomb.y = -256;
		bomb.active = true;
	}
}

///////////////////////////////////////////////////////
////////////// MOUSE AND TOUCH EVENTS /////////////////
///////////////////////////////////////////////////////
function inputMove(e){
	if (e.touches) {
		// Touch Events
		for ( i=1; i <= e.touches.length; i++ ){
			latestCoords[i] = getCoords(e.touches[i - 1]); // Get info for finger #1
		}
	} else {
		// Mouse Events
		latestCoords[0] = getCoords(e);
	}
}

function inputDown(e){ // AKA Input Start
	firstCoords[0] = getCoords(e);
	startSelection();
	lineActive = true;
}
function inputUp(e){ // AKA Input End
	lineActive = false;
	stopSelection();
}

function inputClick(){
	if (player1.selected){
		player1.action = "bomb";
	}
}
///////////////////////////////////////////////////////
///////////////////////////////////////////////////////
///////////////////////////////////////////////////////

function getCoords(e) {
	if (e.offsetX)
		return { x: e.offsetX, y: e.offsetY };
	else if (e.layerX)
		return { x: e.layerX, y: e.layerY };
	else
		return { x: e.pageX - canvas.offsetLeft, y: e.pageY - canvas.offsetTop };
}

function snapFirstCoords(obj){
	// Sets first coordinates to the destination
	// Currently used for snapping to players feet
	firstCoords[0].x = obj.x + obj.w / 2;
	firstCoords[0].y = obj.y + obj.h - 45;
}

function startSelection(){
	// Touch/Click far from character1 && character2
	if (getDistance(latestCoords[0].x, latestCoords[0].y, player1.x, player1.y) > 128 && 
		getDistance(latestCoords[0].x, latestCoords[0].y, player2.x, player2.y) > 128 ){
		inputEvent = "Mouse Down over NOTHING";
		if (player1.selected) player1.selected = false;
		if (player2.selected) player2.selected = false;
	}

	// Touch/Click close to character1?
	if (getDistance(latestCoords[0].x, latestCoords[0].y, player1.x + 64, player1.y + 64) <= player1.selectionTolerance ){
			inputEvent = "Mouse Down over PLAYER 1";
			if (player1.selected) snapFirstCoords(player1);
			if (!player1.selected) player1.selected = true;
			if (player2.selected) player2.selected = false;
	}

	//Touch/Click close to character2?
	if (getDistance(latestCoords[0].x, latestCoords[0].y, player2.x + 64, player2.y + 64) <= player2.selectionTolerance ){
			inputEvent = "Mouse Down over PLAYER 2";
			if (!player2.selected) player2.selected = true;
			if (player1.selected) player1.selected = false;
	}

}
function stopSelection(){
	// Should player2 move
	if ( getDistance(latestCoords[0].x, latestCoords[0].y, player1.x + 64, player1.y + 75) > 64 ){
		if (player1.selected){
			player1.action = "move";
			player1.dx = latestCoords[0].x - player1.w / 2; // X Destination = Middle
			player1.dy = latestCoords[0].y - player1.h + 10; // Y Destination = Base of player
		}
	}
	
	// Should player2 move
	if( getDistance(latestCoords[0].x, latestCoords[0].y, player2.x + 64, player2.y + 75) > 64 ){
		if (player2.selected){
			player2.action = "move";
			player2.dx = latestCoords[0].x - player2.w / 2; // X Destination = Middle
			player2.dy = latestCoords[0].y - player2.h + 10; // Y Destination = Base of player
		}
	}
}

function touchMove(e){ e.preventDefault(); }
function touchStart(e){ e.preventDefault(); }
function touchEnd(e){ }

//////////////// MAIN GAME LOOP ////////////////
var then = Date.now();
function getDelta() {
	var now = Date.now();
	var delta = now - then;

	then = now;
	return (delta / 1000);
}

function animate(){
	// UPDATE
	update();
	var temp = { x:0,y:0 };
	temp = normalize(player1.x, player1.y, player1.dx, player1.dy);
	document.getElementById("test1").innerHTML = "Distance Player to Monster: " + getDistance(player1.x, player1.y, monster.x, monster.y);
	document.getElementById("test2").innerHTML = " |  Mouse/Touch Coords: " + latestCoords[0].x + ", " + latestCoords[0].y;
	document.getElementById("test3").innerHTML = "|  Delta: " + getDelta()*1000;

	document.getElementById("test4").innerHTML = "| Player to Destination: " + player1.x + "," + player1.y + " || " + player1.dx + "," + player1.dy;
	document.getElementById("test5").innerHTML = "| Player Distance to dxy: " + getDistance(player1.x, player1.y, player1.dx, player1.dy);
	document.getElementById("test6").innerHTML = "| Last Event: " + inputEvent;
	document.getElementById("test7").innerHTML = "| Norm Vector: " + temp.x + ", " + temp.y;

	// CLEAR
	context.clearRect(0, 0, canvas.width, canvas.height);

	// RENDER
	render();

	// request new frame
	requestAnimFrame(function(){
		animate();
	});
}

window.onload = function(){
	// Event Listeners
	canvas.ontouchmove = touchMove;
	canvas.ontouchstart = touchStart;
	canvas.ontouchend = touchEnd;

	canvas.onmousedown = inputDown;
	canvas.onmouseup = inputUp;
	canvas.onmousemove = inputMove;
	canvas.onmouseclick = inputClick;
	
	// Initalize Stage
	monster.x = canvas.width - monster.w - 100;
	monster.y = canvas.height / 2 - monster.h /2;
	player2.x = 70;
	player2.y = 250;
	player1.selected = true;
	player2.selected = true;
	
	ASSET_MANAGER.downloadAll(function(){
		animate();
	});
};
</script> 
</body>
</html> 